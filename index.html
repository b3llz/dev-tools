<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPP Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>body{font-family:'Plus Jakarta Sans',sans-serif;background-color:#f8fafc}.loader{border:2px solid #e2e8f0;border-top:2px solid #4f46e5;border-radius:50%;width:14px;height:14px;animation:spin 1s linear infinite;display:inline-block}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
</head>
<body class="pb-24 text-slate-800 bg-slate-50">

    <div id="settingsModal" class="fixed inset-0 z-50 bg-slate-900/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="font-bold text-lg mb-4 text-slate-800">Konfigurasi Admin</h2>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400">Secret Key (App Password)</label>
                    <div class="relative">
                        <input id="inKey" type="text" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500" placeholder="Samakan dengan App.jsx">
                        <i class="fa-solid fa-key absolute right-3 top-3.5 text-slate-400 text-xs"></i>
                    </div>
                </div>
                <hr class="border-slate-100 my-2">
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400">GitHub Token (PAT)</label>
                    <input id="inToken" type="password" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm font-mono outline-none focus:border-indigo-500" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400">Link Gist (Database)</label>
                    <input id="inGist" type="text" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm font-mono outline-none focus:border-indigo-500" placeholder="https://gist.github.com/...">
                    <p class="text-[9px] text-slate-400 mt-1">*Paste link lengkap Gist atau ID-nya saja.</p>
                </div>
                <button onclick="saveConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold text-sm mt-2 shadow-lg">Simpan Konfigurasi</button>
                <button onclick="toggleSettings()" class="w-full text-slate-400 py-2 text-xs font-bold">Tutup</button>
            </div>
        </div>
    </div>

    <nav class="fixed top-0 w-full bg-white/80 backdrop-blur-md z-40 border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md"><i class="fa-solid fa-shield-halved"></i></div>
            <h1 class="font-bold text-slate-800">HPP Admin</h1>
        </div>
        <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:text-indigo-600 transition flex items-center justify-center"><i class="fa-solid fa-gear"></i></button>
    </nav>

    <div class="max-w-md mx-auto pt-24 px-4 space-y-6">
        <div class="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100">
            <h2 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-plus-circle text-indigo-500"></i> Deploy License</h2>
            <div class="space-y-3">
                <input id="tenantName" type="text" placeholder="Nama Client..." class="w-full bg-slate-50 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none focus:bg-white focus:border-indigo-500 transition">
                <div class="flex gap-3">
                    <input id="durationVal" type="number" value="1" class="w-20 text-center bg-slate-50 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none focus:border-indigo-500">
                    <select id="durationUnit" class="flex-1 bg-slate-50 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none focus:border-indigo-500 appearance-none">
                        <option value="month">Bulan</option>
                        <option value="year">Tahun</option>
                        <option value="day">Hari</option>
                    </select>
                </div>
                <button onclick="generate()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2"><i class="fa-solid fa-bolt"></i> GENERATE KEY</button>
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center px-1 mb-3">
                <h3 class="font-bold text-slate-400 text-xs uppercase tracking-wider">Client List</h3>
                <button onclick="loadClients()" class="text-indigo-500 text-xs font-bold">Refresh</button>
            </div>
            <div id="clientList" class="space-y-3"></div>
        </div>
    </div>

        <script>
        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            loadClients();
            if(!localStorage.getItem('gh_token') || !localStorage.getItem('app_secret')) toggleSettings();
        });

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                document.getElementById('inKey').value = localStorage.getItem('app_secret') || '';
                document.getElementById('inToken').value = localStorage.getItem('gh_token') || '';
                document.getElementById('inGist').value = localStorage.getItem('gh_gist') || '';
            }
        }

        function saveConfig() {
            const key = document.getElementById('inKey').value.trim();
            const token = document.getElementById('inToken').value.trim();
            let gistInput = document.getElementById('inGist').value.trim();

            if(!key || !token || !gistInput) return alert("Semua kolom wajib diisi!");

            // Bersihkan URL Gist untuk ambil ID-nya saja
            if(gistInput.endsWith('/')) gistInput = gistInput.slice(0, -1);
            const gistId = gistInput.split('/').pop();

            localStorage.setItem('app_secret', key);
            localStorage.setItem('gh_token', token);
            localStorage.setItem('gh_gist', gistId);
            
            toggleSettings();
            alert("Konfigurasi Tersimpan!");
            loadClients();
        }

        function generate() {
            const secretKey = localStorage.getItem('app_secret');
            if(!secretKey) return alert("Setting dulu Secret Key-nya!");

            const name = document.getElementById('tenantName').value;
            const val = parseInt(document.getElementById('durationVal').value);
            const unit = document.getElementById('durationUnit').value;

            if(!name) return alert("Isi nama dulu!");

            const id = `ID-${name.replace(/\s+/g, '').substring(0,3).toUpperCase()}-${Math.floor(1000+Math.random()*9000)}`;
            const date = new Date();
            if(unit === 'month') date.setMonth(date.getMonth() + val);
            if(unit === 'year') date.setFullYear(date.getFullYear() + val);
            if(unit === 'day') date.setDate(date.getDate() + val);

            const data = { id, tenant: name, validUntil: date.toISOString() };
            
            try {
                const token = CryptoJS.AES.encrypt(JSON.stringify(data), secretKey).toString();
                const newClient = { ...data, token, status: 'active' };
                
                let db = JSON.parse(localStorage.getItem('clients') || '[]');
                db.unshift(newClient);
                localStorage.setItem('clients', JSON.stringify(db));
                
                loadClients();
                document.getElementById('tenantName').value = '';
            } catch (e) { alert("Gagal enkripsi: " + e.message); }
        }

        function loadClients() {
            const db = JSON.parse(localStorage.getItem('clients') || '[]');
            const container = document.getElementById('clientList');
            container.innerHTML = '';

            if(db.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 text-xs py-10 opacity-50">Belum ada client.</p>';
                return;
            }

            db.forEach(c => {
                const isBanned = c.status === 'banned';
                
                const actionBtn = isBanned 
                    ? `<button onclick="toggleBan('${c.id}', 'unban', this)" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-2.5 rounded-lg text-[10px] font-bold shadow-md shadow-emerald-500/20"><i class="fa-solid fa-lock-open mr-1"></i> BUKA</button>`
                    : `<button onclick="toggleBan('${c.id}', 'ban', this)" class="flex-1 bg-white border border-rose-200 text-rose-500 hover:bg-rose-50 py-2.5 rounded-lg text-[10px] font-bold"><i class="fa-solid fa-power-off mr-1"></i> SHUTDOWN</button>`;
                
                const badge = isBanned ? '<span class="text-rose-500 bg-rose-50 px-2 py-0.5 rounded text-[9px] font-bold border border-rose-100">TERKUNCI</span>' : '<span class="text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded text-[9px] font-bold border border-emerald-100">AKTIF</span>';
                const bg = isBanned ? 'bg-slate-50 border-rose-200' : 'bg-white border-slate-100';

                const html = `
                <div class="p-4 rounded-2xl shadow-sm border ${bg} transition-all">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-slate-800 text-sm">${c.tenant}</h4>
                        ${badge}
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex gap-2">
                            <input readonly value="${c.id}" class="flex-1 bg-slate-100 border-0 p-2 rounded-lg text-[10px] font-bold text-slate-600" onclick="this.select()">
                            <button onclick="navigator.clipboard.writeText('${c.id}');alert('ID Disalin!')" class="bg-white border border-slate-200 px-2 rounded-lg text-slate-400 hover:text-indigo-600"><i class="fa-regular fa-copy"></i></button>
                        </div>
                        <div class="flex gap-2">
                            <input readonly value="${c.token}" class="flex-1 bg-slate-100 border-0 p-2 rounded-lg text-[10px] font-mono text-slate-500" onclick="this.select()">
                            <button onclick="navigator.clipboard.writeText('${c.token}');alert('Kode Disalin!')" class="bg-white border border-slate-200 px-2 rounded-lg text-slate-400 hover:text-indigo-600"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2">${actionBtn}<button onclick="del('${c.id}')" class="w-9 bg-slate-100 rounded-lg text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // --- FUNGSI UPDATE YANG SUDAH DIPERBAIKI (SMART FILE DETECTION) ---
        async function toggleBan(id, action, btn) {
            const token = localStorage.getItem('gh_token');
            const gistId = localStorage.getItem('gh_gist');
            
            if(!token || !gistId) return alert("Setting GitHub Token & Gist ID dulu!");

            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span>';
            btn.disabled = true;

            try {
                // 1. Ambil Data Gist
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { Authorization: `token ${token}` }
                });
                
                if(!res.ok) throw new Error("Gagal akses GitHub. Cek Token/ID Gist.");
                const data = await res.json();

                // 2. DETEKSI NAMA FILE OTOMATIS (FIX ERROR 'undefined')
                const fileNames = Object.keys(data.files);
                if (fileNames.length === 0) throw new Error("Gist kosong (tidak ada file).");
                
                // Prioritaskan 'blacklist.json', jika tidak ada, ambil file pertama yang ditemukan
                const targetFileName = fileNames.includes('blacklist.json') ? 'blacklist.json' : fileNames[0];
                
                // Ambil konten file
                let content = data.files[targetFileName].content || '[]';
                let blacklist = [];
                try {
                    blacklist = JSON.parse(content);
                } catch (e) {
                    blacklist = []; // Reset jika format rusak
                }

                // 3. Modifikasi List
                if(action === 'ban') {
                    if(!blacklist.includes(id)) blacklist.push(id);
                } else {
                    blacklist = blacklist.filter(x => x !== id);
                }

                // 4. Update Gist (Pakai nama file yang terdeteksi tadi)
                const updatePayload = { files: {} };
                updatePayload.files[targetFileName] = { content: JSON.stringify(blacklist) };

                await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatePayload)
                });

                // 5. Update Lokal
                let db = JSON.parse(localStorage.getItem('clients') || '[]');
                const idx = db.findIndex(c => c.id === id);
                if(idx !== -1) db[idx].status = (action === 'ban' ? 'banned' : 'active');
                localStorage.setItem('clients', JSON.stringify(db));
                
                loadClients();
                alert(action==='ban' ? "AKSES DIBLOKIR!" : "AKSES DIBUKA!");

            } catch(e) {
                alert("Error: " + e.message); 
                btn.innerHTML = originalHtml; 
                btn.disabled = false; 
            }
        }

        function del(id) {
            if(confirm("Hapus?")) {
                let db = JSON.parse(localStorage.getItem('clients') || '[]');
                db = db.filter(c => c.id !== id);
                localStorage.setItem('clients', JSON.stringify(db));
                loadClients();
            }
        }
    </script>

</body>
</html>
